name: Standalone Dist

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Build
        run: VITE_STANDALONE_SECRET=true bun run build --base ./
      - name: Cleanup Standalone Dist
        run: |
          cd dist
          # Delete unwanted images from public root
          rm -f Example.png T1.png T2.png T3.png template.png profile-photo.png reel-bg.png
          # Delete CNAME
          rm -f CNAME
          # Delete unnecessary fonts, keeping only what's required for Secret page
          if [ -d "fonts" ]; then
            find fonts/ -type f ! -name 'SolaimanLipi-Regular.ttf' ! -name 'Cambria.ttf' ! -name 'cambriab.ttf' -delete
          fi

          # Create .htaccess for Apache routing support
          cat > .htaccess <<EOF
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
          </IfModule>
          EOF

          # Clean index.html from portfolio links and analytics
          sed -i '/og:url/d' index.html
          sed -i '/og:image/d' index.html
          sed -i '/twitter:image/d' index.html
          sed -i '/goatcounter/d' index.html
          sed -i '/gc.zgo.at/d' index.html
          sed -i '/EkusheyLalsalu/d' index.html

          # Remove unwanted assets from assets/ folder
          # The secret page doesn't use any images from src/assets
          rm -f assets/*.png assets/*.jpg assets/*.jpeg assets/*.webp assets/*.svg

          # Remove unused page chunks to keep dist clean
          rm -f assets/AiChat-*.js assets/Analytics-*.js assets/Automation-*.js assets/BanglaGuardian-*.js
          rm -f assets/Dictionary-*.js assets/FontAdminDashboard-*.js assets/FontDocumentation-*.js
          rm -f assets/FontLogin-*.js assets/FontSimplified-*.js assets/FontUserDashboard-*.js
          rm -f assets/HeeraStore-*.js assets/Index-*.js assets/IslamicServices-*.js
          rm -f assets/MazeGame-*.js assets/NuclearCodeSearch-*.js assets/SJ-*.js
          rm -f assets/SearchEngine-*.js assets/Sitemap-*.js assets/VideoAutomation-*.js
          # Note: We keep Secret-*.js and NotFound-*.js as they are used in standalone mode.

      - name: Zip Dist
        run: zip -r standalone-dist.zip dist/
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: standalone-dist.zip
          tag_name: standalone-latest
          name: Standalone Secret Release
          body: |
            Standalone distribution for the Secret page.
            Built with VITE_STANDALONE_SECRET=true.
            Optimized assets and SPA routing fix (HashRouter + .htaccess).
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: standalone-webapp
          path: dist/
